<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš´ë™ KPR ê´€ë¦¬ ì‹œìŠ¤í…œ - í†µí•© í”¼íŠ¸ë‹ˆìŠ¤ ì•±</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ‹ï¸</text></svg>">
    <!-- ê³µí†µ ì»´í¬ë„ŒíŠ¸ ë¡œë“œ -->
    <link rel="stylesheet" href="components/common-styles.css">
    <link rel="stylesheet" href="components/auth-styles.css">
    
    <!-- Firebase SDK -->
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="shared/cloud-data-manager.js"></script>
    <script type="module" src="components/auth-component.js"></script>
    
    <script src="shared/data-manager.js"></script>
    <script src="shared/utils.js"></script>
    <script src="components/navigation.js"></script>
    <style>
        /* ìš´ë™ ê´€ë¦¬ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
        .exercise-item {
            background: var(--bg-white);
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .exercise-item:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }
        
        .exercise-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .exercise-log-list {
            list-style: none;
            padding: 0;
        }
        
        .exercise-log-item {
            display: block;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        .exercise-log-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .exercise-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .exercise-name-log {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        
        .last-session-date {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .session-set-list {
            list-style: none;
            padding-left: 15px;
            font-size: 0.9rem;
        }
        
        .session-set-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }
        
        .workout-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-5);
            margin-bottom: var(--spacing-8);
        }
        
        .workout-section {
            background: var(--bg-gray-50);
            border-radius: 12px;
            padding: var(--spacing-5);
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: var(--spacing-4);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            border-bottom: 2px solid var(--border-light);
            padding-bottom: var(--spacing-2);
        }
        
        .sets-container {
            background: var(--bg-white);
            border-radius: 12px;
            padding: var(--spacing-5);
            margin: var(--spacing-5) 0;
            box-shadow: var(--shadow-md);
        }
        
        .set-row {
            display: grid;
            grid-template-columns: auto 1fr 1fr auto;
            gap: var(--spacing-4);
            align-items: center;
            padding: var(--spacing-3);
            margin-bottom: var(--spacing-3);
            background: var(--bg-gray-50);
            border-radius: 8px;
        }
        
        .set-number {
            font-weight: 600;
            color: var(--primary-blue);
        }
        
        .set-input {
            padding: 8px 12px;
            border: 2px solid var(--border-light);
            border-radius: 6px;
            font-size: 1rem;
            width: 100%;
        }
        
        .set-input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }
        
        .set-volume {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: right;
            min-width: 70px;
        }
        
        .total-volume {
            text-align: center;
            padding: var(--spacing-4);
            background: #e8f4fd;
            border-radius: 8px;
            margin-top: var(--spacing-3);
            font-weight: 600;
            color: #0c5460;
        }
        
        .exercise-selection {
            background: var(--bg-white);
            border-radius: 12px;
            padding: var(--spacing-5);
            margin-bottom: var(--spacing-5);
            box-shadow: var(--shadow-md);
        }
        
        .pr-display {
            text-align: center;
            padding: var(--spacing-3);
            margin-bottom: var(--spacing-4);
            background: #fef9c3;
            color: #713f12;
            border-radius: 8px;
            font-weight: 600;
            border: 1px solid #fde047;
            font-size: 0.9rem;
        }
        
        .pr-display.no-record {
            background: var(--bg-gray-100);
            color: var(--text-secondary);
            border: 1px solid var(--border-light);
        }
        
        .timer-controls {
            display: flex;
            gap: var(--spacing-3);
            justify-content: center;
            margin-bottom: var(--spacing-5);
        }
        
        .nav-tabs {
            display: flex;
            background: var(--bg-white);
            border-radius: 10px;
            margin-bottom: var(--spacing-5);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            flex: 1;
            padding: var(--spacing-4) var(--spacing-3);
            text-align: center;
            cursor: pointer;
            background: var(--bg-white);
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 100px;
        }
        
        .nav-tab:hover {
            background: var(--bg-gray-50);
        }
        
        .nav-tab.active {
            background: var(--primary-gradient);
            color: white;
        }
        
        .content-area {
            background: var(--bg-white);
            border-radius: 15px;
            padding: var(--spacing-6);
            box-shadow: var(--shadow-lg);
        }
        
        @media (max-width: 768px) {
            .nav-tab {
                flex-grow: 1;
                min-width: 80px;
                font-size: 0.8rem;
                padding: 12px 8px;
            }
            
            .workout-sections {
                grid-template-columns: 1fr;
            }
            
            .set-row {
                grid-template-columns: auto 1fr 1fr auto;
                gap: 8px;
            }
            
            .set-volume {
                min-width: 55px;
            }
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ì€ JavaScriptë¡œ ë™ì  ìƒì„± -->

    <div class="container main-container">
        <div class="app-content" style="display: none;">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold">ìš´ë™ KPR ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
                <p class="text-lg text-secondary mt-2">ê°œì¸ ê¸°ë¡ì„ ì¶”ì í•˜ê³  ìš´ë™ ì§„ë„ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>
            </div>
            
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="workout">ğŸ‹ï¸ ìš´ë™ê¸°ë¡</button>
                <button class="nav-tab" data-tab="progress">ğŸ“ˆ ì§„ë„ì¶”ì </button>
                <button class="nav-tab" data-tab="library">ğŸ“š ë¼ì´ë¸ŒëŸ¬ë¦¬</button>
            </div>
        
        <div class="content-area">
            <!-- ìš´ë™ ê¸°ë¡ íƒ­ -->
            <div id="workout-tab" class="tab-content active">
                <!-- íƒ€ì´ë¨¸ ì„¹ì…˜ -->
                <div class="card mb-6">
                    <div class="card-title text-center">íœ´ì‹ íƒ€ì´ë¨¸</div>
                    <div id="timer-display" class="timer-display">00:00</div>
                    <div class="timer-controls">
                        <button id="timer-start" class="btn btn-success">ì‹œì‘</button>
                        <button id="timer-stop" class="btn btn-danger hidden">ì •ì§€</button>
                        <button id="timer-reset" class="btn btn-secondary">ë¦¬ì…‹</button>
                    </div>
                </div>
                
                <!-- ìš´ë™ ì…ë ¥ í¼ -->
                <div id="exercise-form">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>
                
                <!-- ì˜¤ëŠ˜ ìš´ë™ ê¸°ë¡ ë³µì‚¬ ë²„íŠ¼ -->
                <div class="text-center mb-6">
                    <button id="copy-workout" class="btn btn-success">ğŸ“‹ ì˜¤ëŠ˜ ìš´ë™ ê¸°ë¡ ë³µì‚¬</button>
                </div>
                
                <hr class="my-8">
                
                <!-- ìš´ë™ ê¸°ë¡ ì„¹ì…˜ -->
                <div id="workout-history" class="workout-sections">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>
            </div>
            
            <!-- ì§„ë„ ì¶”ì  íƒ­ -->
            <div id="progress-tab" class="tab-content hidden">
                <div class="card">
                    <div class="card-title">ê°œì¸ ê¸°ë¡ (PR) - KPR ê´€ë¦¬</div>
                    <div id="progress-content">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>
            </div>
            
            <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ íƒ­ -->
            <div id="library-tab" class="tab-content hidden">
                <div id="library-content">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>
            </div>
        </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let cloudDataManager;
        let authComponent;
        let workoutData;

        // ì•± ìƒíƒœ
        const appState = {
            activeTab: 'workout',
            timerTime: 0,
            isTimerActive: false,
            timerInterval: null,
            selectedBodyPart: 'í•˜ì²´',
            selectedExercise: '',
            sets: Array.from({ length: 5 }, () => ({ weight: '', reps: '' })),
            notes: '',
            isAuthenticated: false
        };

        // ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™”
        let navigation;
        
        async function initializeApp() {
            try {
                // Firebase ë° í´ë¼ìš°ë“œ ë°ì´í„° ë§¤ë‹ˆì € ì´ˆê¸°í™”
                const { default: CloudDataManager } = await import('./shared/cloud-data-manager.js');
                const { default: AuthComponent } = await import('./components/auth-component.js');
                
                cloudDataManager = new CloudDataManager();
                authComponent = new AuthComponent(cloudDataManager);
                
                // ë¡œì»¬ ë°ì´í„° ë§¤ë‹ˆì € ì´ˆê¸°í™”
                workoutData = new WorkoutDataManager();
                workoutData.setCloudDataManager(cloudDataManager);
                
                navigation = new WorkoutNavigation();
                navigation.init();
                
                // ì¸ì¦ UI í‘œì‹œ
                showAuthenticationUI();
                
            } catch (error) {
                console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨, ë¡œì»¬ ëª¨ë“œë¡œ ì‹¤í–‰:', error);
                // Firebase ì—†ì´ ë¡œì»¬ ëª¨ë“œë¡œ ì‹¤í–‰
                workoutData = new WorkoutDataManager();
                navigation = new WorkoutNavigation();
                navigation.init();
                showMainApp();
            }
        }
        
        function showAuthenticationUI() {
            const mainContainer = document.querySelector('.main-container');
            const authContainer = document.createElement('div');
            authContainer.id = 'auth-section';
            authContainer.className = 'auth-section';
            
            const authTitle = document.createElement('div');
            authTitle.className = 'text-center mb-4';
            authTitle.innerHTML = '<h2>KPR ì¶”ì ê¸°ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</h2><p class="text-muted">í´ë¼ìš°ë“œ ë™ê¸°í™”ë¡œ ìš´ë™ ê¸°ë¡ì„ ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•˜ì„¸ìš”</p>';
            
            authContainer.appendChild(authTitle);
            authContainer.appendChild(authComponent.createAuthUI());
            
            mainContainer.insertBefore(authContainer, mainContainer.firstChild);
            
            // ì¸ì¦ ìƒíƒœ ë³€í™” ê°ì§€
            cloudDataManager.auth.onAuthStateChanged((user) => {
                if (user) {
                    appState.isAuthenticated = true;
                    hideAuthenticationUI();
                    showMainApp();
                } else {
                    appState.isAuthenticated = false;
                }
            });
        }
        
        function hideAuthenticationUI() {
            const authSection = document.getElementById('auth-section');
            if (authSection) {
                authSection.style.display = 'none';
            }
        }
        
        function showMainApp() {
            const appContent = document.querySelector('.app-content');
            if (appContent) {
                appContent.style.display = 'block';
            }
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupEventListeners();
            
            // ì´ˆê¸° íƒ­ ë Œë”ë§
            switchTab('workout');
            
            // ì´ˆê¸° ë Œë”ë§
            render();
            
            // ì €ì¥ëœ ìƒíƒœ ë³µì›
            restoreState();
        }

        function setupEventListeners() {
            // íƒ­ ì „í™˜
            document.addEventListener('click', (e) => {
                if (e.target.matches('.nav-tab')) {
                    const tabName = e.target.dataset.tab;
                    switchTab(tabName);
                }
            });

            // íƒ€ì´ë¨¸ ì´ë²¤íŠ¸
            document.getElementById('timer-start').addEventListener('click', startTimer);
            document.getElementById('timer-stop').addEventListener('click', stopTimer);
            document.getElementById('timer-reset').addEventListener('click', resetTimer);

            // ìš´ë™ ê¸°ë¡ ë³µì‚¬
            document.getElementById('copy-workout').addEventListener('click', copyTodaysWorkout);
        }

        function switchTab(tabName) {
            appState.activeTab = tabName;
            
            // íƒ­ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            
            // íƒ­ ì½˜í…ì¸  í‘œì‹œ/ìˆ¨ê¹€
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('hidden', !content.id.startsWith(tabName));
                content.classList.toggle('active', content.id.startsWith(tabName));
            });
            
            // íƒ­ë³„ ë Œë”ë§
            renderTabContent(tabName);
        }

        function renderTabContent(tabName) {
            switch (tabName) {
                case 'workout':
                    renderWorkoutTab();
                    break;
                case 'progress':
                    renderProgressTab();
                    break;
                case 'library':
                    renderLibraryTab();
                    break;
            }
        }

        function renderWorkoutTab() {
            renderExerciseForm();
            renderWorkoutHistory();
        }

        function renderExerciseForm() {
            const exercises = workoutData.getData('exercises') || {};
            const personalRecords = workoutData.getData('personalRecords') || {};
            const bodyParts = Object.keys(exercises);
            
            // ë§ˆì§€ë§‰ ì„ íƒ ë¶€ìœ„ ë³µì›
            const lastBodyPart = workoutData.getUserPreference('lastSelectedBodyPart');
            if (lastBodyPart && bodyParts.includes(lastBodyPart)) {
                appState.selectedBodyPart = lastBodyPart;
            }

            const formHtml = `
                <div class="exercise-selection">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ë¶€ìœ„ ì„ íƒ</label>
                            <select id="body-part-select" class="form-select">
                                ${bodyParts.map(part => 
                                    `<option value="${part}" ${part === appState.selectedBodyPart ? 'selected' : ''}>${part}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ìš´ë™ ì„ íƒ</label>
                            <select id="exercise-select" class="form-select">
                                <option value="">ìš´ë™ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                ${(exercises[appState.selectedBodyPart] || []).map(exercise => 
                                    `<option value="${exercise}" ${exercise === appState.selectedExercise ? 'selected' : ''}>${exercise}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                </div>
                
                ${appState.selectedExercise ? `
                    <div class="sets-container">
                        <div class="card-title">${appState.selectedExercise} - ì„¸íŠ¸ë³„ ê¸°ë¡</div>
                        
                        ${renderPRDisplay(personalRecords[appState.selectedExercise])}
                        
                        <div id="sets-list">
                            ${appState.sets.map((set, index) => renderSetRow(set, index)).join('')}
                        </div>
                        
                        <div class="total-volume">
                            ì´ ë³¼ë¥¨: ${calculateTotalVolume().toLocaleString()}kg (${getValidSets().length}ì„¸íŠ¸)
                        </div>
                        
                        <div class="form-group mt-4">
                            <label class="form-label">ë©”ëª¨</label>
                            <input type="text" id="exercise-notes" class="form-input" value="${appState.notes}" placeholder="ìš´ë™ì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        
                        <button id="complete-exercise" class="btn btn-primary w-full mt-4" ${getValidSets().length === 0 ? 'disabled' : ''}>
                            ${appState.selectedExercise} ìš´ë™ ì™„ë£Œ (${getValidSets().length}ì„¸íŠ¸)
                        </button>
                    </div>
                ` : ''}
            `;

            document.getElementById('exercise-form').innerHTML = formHtml;
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            if (document.getElementById('body-part-select')) {
                document.getElementById('body-part-select').addEventListener('change', handleBodyPartChange);
            }
            if (document.getElementById('exercise-select')) {
                document.getElementById('exercise-select').addEventListener('change', handleExerciseChange);
            }
            if (document.getElementById('exercise-notes')) {
                document.getElementById('exercise-notes').addEventListener('input', (e) => {
                    appState.notes = e.target.value;
                });
            }
            if (document.getElementById('complete-exercise')) {
                document.getElementById('complete-exercise').addEventListener('click', handleCompleteExercise);
            }
            
            // ì„¸íŠ¸ ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.querySelectorAll('.set-input').forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    const setIndex = Math.floor(index / 2);
                    const field = index % 2 === 0 ? 'weight' : 'reps';
                    updateSet(setIndex, field, e.target.value);
                });
            });
        }

        function renderPRDisplay(pr) {
            if (pr) {
                return `
                    <div class="pr-display">
                        ğŸ† ê°œì¸ ìµœê³ ê¸°ë¡ (PR): ${pr.weight}kg x ${pr.reps}íšŒ (${WorkoutUtils.date.formatKorean(pr.date)})
                    </div>
                `;
            } else {
                return `
                    <div class="pr-display no-record">
                        ì•„ì§ ì´ ìš´ë™ì˜ ê°œì¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                `;
            }
        }

        function renderSetRow(set, index) {
            const volume = WorkoutUtils.workout.calculateVolume(set.weight, set.reps);
            return `
                <div class="set-row">
                    <div class="set-number">${index + 1}ì„¸íŠ¸</div>
                    <input type="number" class="set-input" placeholder="ë¬´ê²Œ (kg)" value="${set.weight}" step="0.5" min="0" inputMode="decimal">
                    <input type="number" class="set-input" placeholder="ë°˜ë³µìˆ˜" value="${set.reps}" min="1" inputMode="numeric">
                    <div class="set-volume">${volume}kg</div>
                </div>
            `;
        }

        function handleBodyPartChange(e) {
            appState.selectedBodyPart = e.target.value;
            appState.selectedExercise = '';
            appState.sets = Array.from({ length: 5 }, () => ({ weight: '', reps: '' }));
            appState.notes = '';
            
            // ì„ íƒ ì €ì¥
            workoutData.setUserPreference('lastSelectedBodyPart', appState.selectedBodyPart);
            
            renderExerciseForm();
        }

        function handleExerciseChange(e) {
            appState.selectedExercise = e.target.value;
            appState.sets = Array.from({ length: 5 }, () => ({ weight: '', reps: '' }));
            appState.notes = '';
            
            renderExerciseForm();
        }

        function updateSet(index, field, value) {
            appState.sets[index][field] = value;
            updateTotalVolume();
        }

        function updateTotalVolume() {
            const totalVolume = calculateTotalVolume();
            const validSetsCount = getValidSets().length;
            
            const totalVolumeElement = document.querySelector('.total-volume');
            if (totalVolumeElement) {
                totalVolumeElement.textContent = `ì´ ë³¼ë¥¨: ${totalVolume.toLocaleString()}kg (${validSetsCount}ì„¸íŠ¸)`;
            }
            
            const completeButton = document.getElementById('complete-exercise');
            if (completeButton) {
                completeButton.disabled = validSetsCount === 0;
                completeButton.textContent = `${appState.selectedExercise} ìš´ë™ ì™„ë£Œ (${validSetsCount}ì„¸íŠ¸)`;
            }
        }

        function calculateTotalVolume() {
            return WorkoutUtils.workout.calculateTotalVolume(appState.sets);
        }

        function getValidSets() {
            return WorkoutUtils.workout.getValidSets(appState.sets);
        }

        function handleCompleteExercise() {
            const validSets = getValidSets();
            if (validSets.length === 0) {
                alert('ìµœì†Œ 1ì„¸íŠ¸ì˜ ë¬´ê²Œì™€ ë°˜ë³µìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const sessionDate = new Date().toISOString();
            const records = validSets.map((set, index) => ({
                id: Date.now() + index,
                name: appState.selectedExercise,
                weight: parseFloat(set.weight),
                reps: parseInt(set.reps, 10),
                sets: 1,
                setNumber: index + 1,
                totalSets: validSets.length,
                notes: index === 0 ? appState.notes : '',
                date: sessionDate,
                bodyPart: appState.selectedBodyPart
            }));

            const result = workoutData.addWorkoutRecord(records);
            
            if (result.success) {
                const exerciseName = appState.selectedExercise;
                
                // ìƒíƒœ ì´ˆê¸°í™”
                appState.selectedExercise = '';
                appState.sets = Array.from({ length: 5 }, () => ({ weight: '', reps: '' }));
                appState.notes = '';
                
                renderExerciseForm();
                renderWorkoutHistory();
                
                alert(`${exerciseName} ${validSets.length}ì„¸íŠ¸ê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            }
        }

        function renderWorkoutHistory() {
            const exercises = workoutData.getData('exercises') || {};
            const workoutHistory = workoutData.getData('workoutHistory') || [];
            const bodyParts = Object.keys(exercises);

            const historyHtml = bodyParts.map(part => {
                const partExercises = exercises[part] || [];
                const partRecords = partExercises.map(exerciseName => {
                    const exerciseRecords = workoutHistory.filter(h => h.name === exerciseName);
                    if (exerciseRecords.length === 0) return null;

                    const latestDateStr = new Date(Math.max(...exerciseRecords.map(r => new Date(r.date)))).toDateString();
                    const lastSessionRecords = exerciseRecords
                        .filter(r => new Date(r.date).toDateString() === latestDateStr)
                        .sort((a, b) => a.setNumber - b.setNumber);
                    
                    if (lastSessionRecords.length === 0) return null;

                    const maxWeightInSession = Math.max(...lastSessionRecords.map(r => r.weight));

                    return `
                        <li class="exercise-log-item">
                            <div class="exercise-log-header">
                                <span class="exercise-name-log">${exerciseName}</span>
                                <span class="last-session-date">${WorkoutUtils.date.formatKorean(lastSessionRecords[0].date)}</span>
                            </div>
                            <ul class="session-set-list">
                                ${lastSessionRecords.map(set => `
                                    <li class="session-set-item" style="font-weight: ${set.weight === maxWeightInSession ? 'bold' : 'normal'}">
                                        <span>${set.setNumber}ì„¸íŠ¸</span>
                                        <span>${set.weight}kg Ã— ${set.reps}íšŒ</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </li>
                    `;
                }).filter(Boolean);

                if (partRecords.length === 0) return '';

                return `
                    <div class="workout-section">
                        <div class="section-title">${part}</div>
                        <ul class="exercise-log-list">
                            ${partRecords.join('')}
                        </ul>
                    </div>
                `;
            }).join('');

            document.getElementById('workout-history').innerHTML = historyHtml;
        }

        function renderProgressTab() {
            const personalRecords = workoutData.getData('personalRecords') || {};
            const exercises = workoutData.getData('exercises') || {};
            const bodyParts = Object.keys(exercises);

            if (Object.keys(personalRecords).length === 0) {
                document.getElementById('progress-content').innerHTML = `
                    <div class="text-center p-8 text-secondary">
                        ì•„ì§ ê°œì¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                `;
                return;
            }

            const progressHtml = bodyParts.map(part => {
                const partPRs = Object.entries(personalRecords).filter(([name, record]) => 
                    (exercises[part] || []).includes(name)
                );
                
                if (partPRs.length === 0) return '';

                return `
                    <div class="workout-section mb-6">
                        <div class="section-title">${part}</div>
                        ${partPRs.map(([name, record]) => `
                            <div class="card p-4 mb-3">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-bold">${name}</span>
                                    <span class="font-bold">${record.weight}kg Ã— ${record.reps}íšŒ</span>
                                </div>
                                <div class="text-sm text-secondary">
                                    ì¶”ì • 1RM: ${record.oneRM}kg | ë‹¬ì„±: ${WorkoutUtils.date.formatKorean(record.date)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');

            document.getElementById('progress-content').innerHTML = progressHtml;
        }

        function renderLibraryTab() {
            const exercises = workoutData.getData('exercises') || {};
            const bodyParts = Object.keys(exercises);

            const libraryHtml = `
                <div class="card mb-6">
                    <div class="form-group">
                        <label class="form-label">ê²€ìƒ‰</label>
                        <input type="text" id="library-search" class="form-input" placeholder="ìš´ë™ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰...">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ë¶€ìœ„ í•„í„°</label>
                            <select id="library-filter" class="form-select">
                                <option value="">ì „ì²´</option>
                                ${bodyParts.map(part => `<option value="${part}">${part}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group flex items-end">
                            <button id="add-exercise-btn" class="btn btn-primary w-full">ìƒˆ ìš´ë™ ì¶”ê°€</button>
                        </div>
                    </div>
                </div>

                <div id="add-exercise-form" class="card mb-6 hidden">
                    <div class="card-title">ìƒˆ ìš´ë™ ì¶”ê°€</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ìš´ë™ ì´ë¦„</label>
                            <input type="text" id="new-exercise-name" class="form-input" placeholder="ìš´ë™ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ë¶€ìœ„</label>
                            <select id="new-exercise-bodypart" class="form-select">
                                ${bodyParts.map(part => `<option value="${part}">${part}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button id="save-exercise" class="btn btn-success">ì¶”ê°€í•˜ê¸°</button>
                        <button id="cancel-exercise" class="btn btn-secondary">ì·¨ì†Œ</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">ìš´ë™ ë¼ì´ë¸ŒëŸ¬ë¦¬</div>
                    <div id="exercise-library-list">
                        ${renderExerciseList(exercises)}
                    </div>
                </div>
            `;

            document.getElementById('library-content').innerHTML = libraryHtml;

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            setupLibraryEventListeners();
        }

        function renderExerciseList(exercises, searchTerm = '', filterBodyPart = '') {
            const allExercises = [];
            Object.entries(exercises).forEach(([bodyPart, exerciseList]) => {
                exerciseList.forEach(name => {
                    if ((!searchTerm || name.toLowerCase().includes(searchTerm.toLowerCase())) &&
                        (!filterBodyPart || bodyPart === filterBodyPart)) {
                        allExercises.push({ name, bodyPart });
                    }
                });
            });

            if (allExercises.length === 0) {
                return '<div class="text-center p-4 text-secondary">ìš´ë™ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }

            return allExercises.map(({ name, bodyPart }) => `
                <div class="exercise-item">
                    <span class="exercise-name">
                        ${name} 
                        <span class="inline-block bg-gray-200 text-gray-600 px-2 py-1 rounded-full text-xs ml-2">${bodyPart}</span>
                    </span>
                    <button class="btn btn-danger btn-sm" onclick="deleteExercise('${bodyPart}', '${name}')">ì‚­ì œ</button>
                </div>
            `).join('');
        }

        function setupLibraryEventListeners() {
            const searchInput = document.getElementById('library-search');
            const filterSelect = document.getElementById('library-filter');
            const addBtn = document.getElementById('add-exercise-btn');
            const addForm = document.getElementById('add-exercise-form');

            searchInput?.addEventListener('input', updateExerciseList);
            filterSelect?.addEventListener('change', updateExerciseList);

            addBtn?.addEventListener('click', () => {
                addForm.classList.remove('hidden');
                addBtn.classList.add('hidden');
            });

            document.getElementById('cancel-exercise')?.addEventListener('click', () => {
                addForm.classList.add('hidden');
                addBtn.classList.remove('hidden');
                clearAddExerciseForm();
            });

            document.getElementById('save-exercise')?.addEventListener('click', handleAddExercise);
        }

        function updateExerciseList() {
            const searchTerm = document.getElementById('library-search').value;
            const filterBodyPart = document.getElementById('library-filter').value;
            const exercises = workoutData.getData('exercises') || {};
            
            document.getElementById('exercise-library-list').innerHTML = 
                renderExerciseList(exercises, searchTerm, filterBodyPart);
        }

        function handleAddExercise() {
            const name = document.getElementById('new-exercise-name').value.trim();
            const bodyPart = document.getElementById('new-exercise-bodypart').value;

            if (!name) {
                alert('ìš´ë™ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            const success = workoutData.addExercise(bodyPart, name);
            if (success) {
                clearAddExerciseForm();
                document.getElementById('add-exercise-form').classList.add('hidden');
                document.getElementById('add-exercise-btn').classList.remove('hidden');
                updateExerciseList();
                alert(`${name} ìš´ë™ì´ ${bodyPart}ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } else {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìš´ë™ì…ë‹ˆë‹¤.');
            }
        }

        function clearAddExerciseForm() {
            document.getElementById('new-exercise-name').value = '';
        }

        window.deleteExercise = function(bodyPart, exerciseName) {
            if (confirm(`'${exerciseName}' ìš´ë™ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                workoutData.removeExercise(bodyPart, exerciseName);
                updateExerciseList();
            }
        };

        // íƒ€ì´ë¨¸ ê´€ë ¨ í•¨ìˆ˜
        function startTimer() {
            appState.isTimerActive = true;
            appState.timerInterval = setInterval(() => {
                appState.timerTime++;
                updateTimerDisplay();
            }, 1000);
            
            document.getElementById('timer-start').classList.add('hidden');
            document.getElementById('timer-stop').classList.remove('hidden');
        }

        function stopTimer() {
            appState.isTimerActive = false;
            if (appState.timerInterval) {
                clearInterval(appState.timerInterval);
                appState.timerInterval = null;
            }
            
            document.getElementById('timer-start').classList.remove('hidden');
            document.getElementById('timer-stop').classList.add('hidden');
        }

        function resetTimer() {
            stopTimer();
            appState.timerTime = 0;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            document.getElementById('timer-display').textContent = WorkoutUtils.timer.formatTime(appState.timerTime);
        }

        function copyTodaysWorkout() {
            const now = new Date();
            const startOfToday = WorkoutUtils.date.getStartOfDay(now);
            const workoutHistory = workoutData.getData('workoutHistory') || [];
            
            const todaysWorkouts = workoutHistory
                .filter(w => new Date(w.date) >= startOfToday)
                .reverse();
            
            if (todaysWorkouts.length === 0) {
                alert('ì˜¤ëŠ˜ ê¸°ë¡ëœ ìš´ë™ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const groupedByExercise = todaysWorkouts.reduce((acc, workout) => {
                if (!acc[workout.name]) acc[workout.name] = [];
                acc[workout.name].push(workout);
                return acc;
            }, {});

            let clipboardText = `[${WorkoutUtils.date.formatKorean(now)} ìš´ë™ ê¸°ë¡]\n\n`;
            
            for (const exerciseName in groupedByExercise) {
                clipboardText += `ğŸ”¥ ${exerciseName}\n`;
                const sets = groupedByExercise[exerciseName];
                const mainNote = sets.find(s => s.notes)?.notes || '';
                
                sets.sort((a, b) => a.setNumber - b.setNumber).forEach(set => {
                    clipboardText += `  - ${set.setNumber}ì„¸íŠ¸: ${set.weight}kg x ${set.reps}íšŒ\n`;
                });
                
                if (mainNote) clipboardText += `  ğŸ“ ë©”ëª¨: ${mainNote}\n`;
                clipboardText += '\n';
            }

            navigator.clipboard.writeText(clipboardText.trim()).then(() => {
                alert('ì˜¤ëŠ˜ì˜ ìš´ë™ ê¸°ë¡ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(() => {
                // í´ë°±: í…ìŠ¤íŠ¸ ì˜ì—­ ì‚¬ìš©
                const textarea = document.createElement('textarea');
                textarea.value = clipboardText.trim();
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    alert('ì˜¤ëŠ˜ì˜ ìš´ë™ ê¸°ë¡ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } catch (err) {
                    alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                document.body.removeChild(textarea);
            });
        }

        function restoreState() {
            // ì €ì¥ëœ ì‚¬ìš©ì ì„¤ì • ë³µì›
            const lastBodyPart = workoutData.getUserPreference('lastSelectedBodyPart');
            if (lastBodyPart) {
                appState.selectedBodyPart = lastBodyPart;
            }
        }

        function render() {
            renderTabContent(appState.activeTab);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            
            // ë°ì´í„° ë³€ê²½ ê°ì§€
            workoutData.onDataChange((event) => {
                console.log('Data changed:', event.detail);
                // í•„ìš”ì‹œ UI ì—…ë°ì´íŠ¸
                if (appState.activeTab === 'workout') {
                    renderWorkoutHistory();
                }
            });
        });
        
        // ìš´ë™ ê¸°ë¡ ì €ì¥ ì‹œ í´ë¼ìš°ë“œ ë™ê¸°í™”
        async function saveWorkoutRecord() {
            const records = getWorkoutRecords();
            
            if (records.length === 0) {
                alert('ì €ì¥í•  ìš´ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                // í´ë¼ìš°ë“œ + ë¡œì»¬ ì €ì¥
                const result = await workoutData.addWorkoutRecord(records);
                
                if (result.success) {
                    alert(`${result.recordsAdded}ê°œì˜ ìš´ë™ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    clearWorkoutForm();
                    renderWorkoutHistory();
                    renderProgressTab();
                } else {
                    alert('ìš´ë™ ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ìš´ë™ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ìš´ë™ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ìš´ë™ ê¸°ë¡ ë°ì´í„° ìˆ˜ì§‘
        function getWorkoutRecords() {
            const records = [];
            const exerciseName = appState.selectedExercise;
            
            if (!exerciseName) return records;
            
            appState.sets.forEach((set, index) => {
                if (set.weight && set.reps && set.weight > 0 && set.reps > 0) {
                    records.push({
                        id: `${Date.now()}_${index}`,
                        name: exerciseName,
                        weight: parseFloat(set.weight),
                        reps: parseInt(set.reps),
                        date: new Date().toISOString().split('T')[0],
                        notes: appState.notes || '',
                        setNumber: index + 1,
                        bodyPart: appState.selectedBodyPart
                    });
                }
            });
            
            return records;
        }
        
        // ìš´ë™ ê¸°ë¡ í¼ ì´ˆê¸°í™”
        function clearWorkoutForm() {
            appState.sets = Array.from({ length: 5 }, () => ({ weight: '', reps: '' }));
            appState.notes = '';
            renderExerciseForm();
        }
    </script>
</body>
</html>