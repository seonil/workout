<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>운동 KPR 관리 시스템 - 통합 피트니스 앱</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🏋️</text></svg>">
    <!-- 공통 컴포넌트 로드 -->
    <link rel="stylesheet" href="components/common-styles.css">
    <link rel="stylesheet" href="components/auth-styles.css">
    
    <!-- Firebase SDK -->
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="shared/cloud-data-manager.js"></script>
    <script type="module" src="components/auth-component.js"></script>
    
    <script src="shared/data-manager.js"></script>
    <script src="shared/utils.js"></script>
    <script src="components/navigation.js"></script>
    <style>
        /* 운동 관리 페이지 전용 스타일 */
        .exercise-item {
            background: var(--bg-white);
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .exercise-item:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }
        
        .exercise-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .exercise-log-list {
            list-style: none;
            padding: 0;
        }
        
        .exercise-log-item {
            display: block;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        .exercise-log-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .exercise-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .exercise-name-log {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        
        .last-session-date {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .session-set-list {
            list-style: none;
            padding-left: 15px;
            font-size: 0.9rem;
        }
        
        .session-set-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }
        
        .workout-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-5);
            margin-bottom: var(--spacing-8);
        }
        
        .workout-section {
            background: var(--bg-gray-50);
            border-radius: 12px;
            padding: var(--spacing-5);
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: var(--spacing-4);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            border-bottom: 2px solid var(--border-light);
            padding-bottom: var(--spacing-2);
        }
        
        .sets-container {
            background: var(--bg-white);
            border-radius: 12px;
            padding: var(--spacing-5);
            margin: var(--spacing-5) 0;
            box-shadow: var(--shadow-md);
        }
        
        .set-row {
            display: grid;
            grid-template-columns: auto 1fr 1fr auto;
            gap: var(--spacing-4);
            align-items: center;
            padding: var(--spacing-3);
            margin-bottom: var(--spacing-3);
            background: var(--bg-gray-50);
            border-radius: 8px;
        }
        
        .set-number {
            font-weight: 600;
            color: var(--primary-blue);
        }
        
        .set-input {
            padding: 8px 12px;
            border: 2px solid var(--border-light);
            border-radius: 6px;
            font-size: 1rem;
            width: 100%;
        }
        
        .set-input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }
        
        .set-volume {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: right;
            min-width: 70px;
        }
        
        .total-volume {
            text-align: center;
            padding: var(--spacing-4);
            background: #e8f4fd;
            border-radius: 8px;
            margin-top: var(--spacing-3);
            font-weight: 600;
            color: #0c5460;
        }
        
        .exercise-selection {
            background: var(--bg-white);
            border-radius: 12px;
            padding: var(--spacing-5);
            margin-bottom: var(--spacing-5);
            box-shadow: var(--shadow-md);
        }
        
        .pr-display {
            text-align: center;
            padding: var(--spacing-3);
            margin-bottom: var(--spacing-4);
            background: #fef9c3;
            color: #713f12;
            border-radius: 8px;
            font-weight: 600;
            border: 1px solid #fde047;
            font-size: 0.9rem;
        }
        
        .pr-display.no-record {
            background: var(--bg-gray-100);
            color: var(--text-secondary);
            border: 1px solid var(--border-light);
        }
        
        .timer-controls {
            display: flex;
            gap: var(--spacing-3);
            justify-content: center;
            margin-bottom: var(--spacing-5);
        }
        
        .nav-tabs {
            display: flex;
            background: var(--bg-white);
            border-radius: 10px;
            margin-bottom: var(--spacing-5);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            flex: 1;
            padding: var(--spacing-4) var(--spacing-3);
            text-align: center;
            cursor: pointer;
            background: var(--bg-white);
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 100px;
        }
        
        .nav-tab:hover {
            background: var(--bg-gray-50);
        }
        
        .nav-tab.active {
            background: var(--primary-gradient);
            color: white;
        }
        
        .content-area {
            background: var(--bg-white);
            border-radius: 15px;
            padding: var(--spacing-6);
            box-shadow: var(--shadow-lg);
        }
        
        @media (max-width: 768px) {
            .nav-tab {
                flex-grow: 1;
                min-width: 80px;
                font-size: 0.8rem;
                padding: 12px 8px;
            }
            
            .workout-sections {
                grid-template-columns: 1fr;
            }
            
            .set-row {
                grid-template-columns: auto 1fr 1fr auto;
                gap: 8px;
            }
            
            .set-volume {
                min-width: 55px;
            }
        }
    </style>
</head>
<body>
    <!-- 네비게이션은 JavaScript로 동적 생성 -->

    <div class="container main-container">
        <div class="app-content" style="display: none;">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold">운동 KPR 관리 시스템</h1>
                <p class="text-lg text-secondary mt-2">개인 기록을 추적하고 운동 진도를 관리하세요</p>
            </div>
            
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="workout">🏋️ 운동기록</button>
                <button class="nav-tab" data-tab="progress">📈 진도추적</button>
                <button class="nav-tab" data-tab="library">📚 라이브러리</button>
            </div>
        
        <div class="content-area">
            <!-- 운동 기록 탭 -->
            <div id="workout-tab" class="tab-content active">
                <!-- 타이머 섹션 -->
                <div class="card mb-6">
                    <div class="card-title text-center">휴식 타이머</div>
                    <div id="timer-display" class="timer-display">00:00</div>
                    <div class="timer-controls">
                        <button id="timer-start" class="btn btn-success">시작</button>
                        <button id="timer-stop" class="btn btn-danger hidden">정지</button>
                        <button id="timer-reset" class="btn btn-secondary">리셋</button>
                    </div>
                </div>
                
                <!-- 운동 입력 폼 -->
                <div id="exercise-form">
                    <!-- JavaScript로 동적 생성 -->
                </div>
                
                <!-- 오늘 운동 기록 복사 버튼 -->
                <div class="text-center mb-6">
                    <button id="copy-workout" class="btn btn-success">📋 오늘 운동 기록 복사</button>
                </div>
                
                <hr class="my-8">
                
                <!-- 운동 기록 섹션 -->
                <div id="workout-history" class="workout-sections">
                    <!-- JavaScript로 동적 생성 -->
                </div>
            </div>
            
            <!-- 진도 추적 탭 -->
            <div id="progress-tab" class="tab-content hidden">
                <div class="card">
                    <div class="card-title">개인 기록 (PR) - KPR 관리</div>
                    <div id="progress-content">
                        <!-- JavaScript로 동적 생성 -->
                    </div>
                </div>
            </div>
            
            <!-- 라이브러리 탭 -->
            <div id="library-tab" class="tab-content hidden">
                <div id="library-content">
                    <!-- JavaScript로 동적 생성 -->
                </div>
            </div>
        </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let cloudDataManager;
        let authComponent;
        let workoutData;

        // 앱 상태
        const appState = {
            activeTab: 'workout',
            timerTime: 0,
            isTimerActive: false,
            timerInterval: null,
            selectedBodyPart: '하체',
            selectedExercise: '',
            sets: Array.from({ length: 5 }, () => ({ weight: '', reps: '' })),
            notes: '',
            isAuthenticated: false
        };

        // 네비게이션 초기화
        let navigation;
        
        async function initializeApp() {
            try {
                // Firebase 및 클라우드 데이터 매니저 초기화
                const { default: CloudDataManager } = await import('./shared/cloud-data-manager.js');
                const { default: AuthComponent } = await import('./components/auth-component.js');
                
                cloudDataManager = new CloudDataManager();
                authComponent = new AuthComponent(cloudDataManager);
                
                // 로컬 데이터 매니저 초기화
                workoutData = new WorkoutDataManager();
                workoutData.setCloudDataManager(cloudDataManager);
                
                navigation = new WorkoutNavigation();
                navigation.init();
                
                // 인증 UI 표시
                showAuthenticationUI();
                
            } catch (error) {
                console.error('Firebase 초기화 실패, 로컬 모드로 실행:', error);
                // Firebase 없이 로컬 모드로 실행
                workoutData = new WorkoutDataManager();
                navigation = new WorkoutNavigation();
                navigation.init();
                showMainApp();
            }
        }
        
        function showAuthenticationUI() {
            const mainContainer = document.querySelector('.main-container');
            const authContainer = document.createElement('div');
            authContainer.id = 'auth-section';
            authContainer.className = 'auth-section';
            
            const authTitle = document.createElement('div');
            authTitle.className = 'text-center mb-4';
            authTitle.innerHTML = '<h2>KPR 추적기에 오신 것을 환영합니다</h2><p class="text-muted">클라우드 동기화로 운동 기록을 안전하게 관리하세요</p>';
            
            authContainer.appendChild(authTitle);
            authContainer.appendChild(authComponent.createAuthUI());
            
            mainContainer.insertBefore(authContainer, mainContainer.firstChild);
            
            // 인증 상태 변화 감지
            cloudDataManager.auth.onAuthStateChanged((user) => {
                if (user) {
                    appState.isAuthenticated = true;
                    hideAuthenticationUI();
                    showMainApp();
                } else {
                    appState.isAuthenticated = false;
                }
            });
        }
        
        function hideAuthenticationUI() {
            const authSection = document.getElementById('auth-section');
            if (authSection) {
                authSection.style.display = 'none';
            }
        }
        
        function showMainApp() {
            const appContent = document.querySelector('.app-content');
            if (appContent) {
                appContent.style.display = 'block';
            }
            
            // 이벤트 리스너 설정
            setupEventListeners();
            
            // 초기 탭 렌더링
            switchTab('workout');
            
            // 초기 렌더링
            render();
            
            // 저장된 상태 복원
            restoreState();
        }

        function setupEventListeners() {
            // 탭 전환
            document.addEventListener('click', (e) => {
                if (e.target.matches('.nav-tab')) {
                    const tabName = e.target.dataset.tab;
                    switchTab(tabName);
                }
            });

            // 타이머 이벤트
            document.getElementById('timer-start').addEventListener('click', startTimer);
            document.getElementById('timer-stop').addEventListener('click', stopTimer);
            document.getElementById('timer-reset').addEventListener('click', resetTimer);

            // 운동 기록 복사
            document.getElementById('copy-workout').addEventListener('click', copyTodaysWorkout);
        }

        function switchTab(tabName) {
            appState.activeTab = tabName;
            
            // 탭 버튼 상태 업데이트
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            
            // 탭 콘텐츠 표시/숨김
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('hidden', !content.id.startsWith(tabName));
                content.classList.toggle('active', content.id.startsWith(tabName));
            });
            
            // 탭별 렌더링
            renderTabContent(tabName);
        }

        function renderTabContent(tabName) {
            switch (tabName) {
                case 'workout':
                    renderWorkoutTab();
                    break;
                case 'progress':
                    renderProgressTab();
                    break;
                case 'library':
                    renderLibraryTab();
                    break;
            }
        }

        function renderWorkoutTab() {
            renderExerciseForm();
            renderWorkoutHistory();
        }

        function renderExerciseForm() {
            const exercises = workoutData.getData('exercises') || {};
            const personalRecords = workoutData.getData('personalRecords') || {};
            const bodyParts = Object.keys(exercises);
            
            // 마지막 선택 부위 복원
            const lastBodyPart = workoutData.getUserPreference('lastSelectedBodyPart');
            if (lastBodyPart && bodyParts.includes(lastBodyPart)) {
                appState.selectedBodyPart = lastBodyPart;
            }

            const formHtml = `
                <div class="exercise-selection">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">부위 선택</label>
                            <select id="body-part-select" class="form-select">
                                ${bodyParts.map(part => 
                                    `<option value="${part}" ${part === appState.selectedBodyPart ? 'selected' : ''}>${part}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">운동 선택</label>
                            <select id="exercise-select" class="form-select">
                                <option value="">운동을 선택하세요</option>
                                ${(exercises[appState.selectedBodyPart] || []).map(exercise => 
                                    `<option value="${exercise}" ${exercise === appState.selectedExercise ? 'selected' : ''}>${exercise}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                </div>
                
                ${appState.selectedExercise ? `
                    <div class="sets-container">
                        <div class="card-title">${appState.selectedExercise} - 세트별 기록</div>
                        
                        ${renderPRDisplay(personalRecords[appState.selectedExercise])}
                        
                        <div id="sets-list">
                            ${appState.sets.map((set, index) => renderSetRow(set, index)).join('')}
                        </div>
                        
                        <div class="total-volume">
                            총 볼륨: ${calculateTotalVolume().toLocaleString()}kg (${getValidSets().length}세트)
                        </div>
                        
                        <div class="form-group mt-4">
                            <label class="form-label">메모</label>
                            <input type="text" id="exercise-notes" class="form-input" value="${appState.notes}" placeholder="운동에 대한 메모를 입력하세요">
                        </div>
                        
                        <button id="complete-exercise" class="btn btn-primary w-full mt-4" ${getValidSets().length === 0 ? 'disabled' : ''}>
                            ${appState.selectedExercise} 운동 완료 (${getValidSets().length}세트)
                        </button>
                    </div>
                ` : ''}
            `;

            document.getElementById('exercise-form').innerHTML = formHtml;
            
            // 이벤트 리스너 추가
            if (document.getElementById('body-part-select')) {
                document.getElementById('body-part-select').addEventListener('change', handleBodyPartChange);
            }
            if (document.getElementById('exercise-select')) {
                document.getElementById('exercise-select').addEventListener('change', handleExerciseChange);
            }
            if (document.getElementById('exercise-notes')) {
                document.getElementById('exercise-notes').addEventListener('input', (e) => {
                    appState.notes = e.target.value;
                });
            }
            if (document.getElementById('complete-exercise')) {
                document.getElementById('complete-exercise').addEventListener('click', handleCompleteExercise);
            }
            
            // 세트 입력 이벤트 리스너
            document.querySelectorAll('.set-input').forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    const setIndex = Math.floor(index / 2);
                    const field = index % 2 === 0 ? 'weight' : 'reps';
                    updateSet(setIndex, field, e.target.value);
                });
            });
        }

        function renderPRDisplay(pr) {
            if (pr) {
                return `
                    <div class="pr-display">
                        🏆 개인 최고기록 (PR): ${pr.weight}kg x ${pr.reps}회 (${WorkoutUtils.date.formatKorean(pr.date)})
                    </div>
                `;
            } else {
                return `
                    <div class="pr-display no-record">
                        아직 이 운동의 개인 기록이 없습니다.
                    </div>
                `;
            }
        }

        function renderSetRow(set, index) {
            const volume = WorkoutUtils.workout.calculateVolume(set.weight, set.reps);
            return `
                <div class="set-row">
                    <div class="set-number">${index + 1}세트</div>
                    <input type="number" class="set-input" placeholder="무게 (kg)" value="${set.weight}" step="0.5" min="0" inputMode="decimal">
                    <input type="number" class="set-input" placeholder="반복수" value="${set.reps}" min="1" inputMode="numeric">
                    <div class="set-volume">${volume}kg</div>
                </div>
            `;
        }

        function handleBodyPartChange(e) {
            appState.selectedBodyPart = e.target.value;
            appState.selectedExercise = '';
            appState.sets = Array.from({ length: 5 }, () => ({ weight: '', reps: '' }));
            appState.notes = '';
            
            // 선택 저장
            workoutData.setUserPreference('lastSelectedBodyPart', appState.selectedBodyPart);
            
            renderExerciseForm();
        }

        function handleExerciseChange(e) {
            appState.selectedExercise = e.target.value;
            appState.sets = Array.from({ length: 5 }, () => ({ weight: '', reps: '' }));
            appState.notes = '';
            
            renderExerciseForm();
        }

        function updateSet(index, field, value) {
            appState.sets[index][field] = value;
            updateTotalVolume();
        }

        function updateTotalVolume() {
            const totalVolume = calculateTotalVolume();
            const validSetsCount = getValidSets().length;
            
            const totalVolumeElement = document.querySelector('.total-volume');
            if (totalVolumeElement) {
                totalVolumeElement.textContent = `총 볼륨: ${totalVolume.toLocaleString()}kg (${validSetsCount}세트)`;
            }
            
            const completeButton = document.getElementById('complete-exercise');
            if (completeButton) {
                completeButton.disabled = validSetsCount === 0;
                completeButton.textContent = `${appState.selectedExercise} 운동 완료 (${validSetsCount}세트)`;
            }
        }

        function calculateTotalVolume() {
            return WorkoutUtils.workout.calculateTotalVolume(appState.sets);
        }

        function getValidSets() {
            return WorkoutUtils.workout.getValidSets(appState.sets);
        }

        function handleCompleteExercise() {
            const validSets = getValidSets();
            if (validSets.length === 0) {
                alert('최소 1세트의 무게와 반복수를 입력해주세요.');
                return;
            }
            
            const sessionDate = new Date().toISOString();
            const records = validSets.map((set, index) => ({
                id: Date.now() + index,
                name: appState.selectedExercise,
                weight: parseFloat(set.weight),
                reps: parseInt(set.reps, 10),
                sets: 1,
                setNumber: index + 1,
                totalSets: validSets.length,
                notes: index === 0 ? appState.notes : '',
                date: sessionDate,
                bodyPart: appState.selectedBodyPart
            }));

            const result = workoutData.addWorkoutRecord(records);
            
            if (result.success) {
                const exerciseName = appState.selectedExercise;
                
                // 상태 초기화
                appState.selectedExercise = '';
                appState.sets = Array.from({ length: 5 }, () => ({ weight: '', reps: '' }));
                appState.notes = '';
                
                renderExerciseForm();
                renderWorkoutHistory();
                
                alert(`${exerciseName} ${validSets.length}세트가 기록되었습니다!`);
            }
        }

        function renderWorkoutHistory() {
            const exercises = workoutData.getData('exercises') || {};
            const workoutHistory = workoutData.getData('workoutHistory') || [];
            const bodyParts = Object.keys(exercises);

            const historyHtml = bodyParts.map(part => {
                const partExercises = exercises[part] || [];
                const partRecords = partExercises.map(exerciseName => {
                    const exerciseRecords = workoutHistory.filter(h => h.name === exerciseName);
                    if (exerciseRecords.length === 0) return null;

                    const latestDateStr = new Date(Math.max(...exerciseRecords.map(r => new Date(r.date)))).toDateString();
                    const lastSessionRecords = exerciseRecords
                        .filter(r => new Date(r.date).toDateString() === latestDateStr)
                        .sort((a, b) => a.setNumber - b.setNumber);
                    
                    if (lastSessionRecords.length === 0) return null;

                    const maxWeightInSession = Math.max(...lastSessionRecords.map(r => r.weight));

                    return `
                        <li class="exercise-log-item">
                            <div class="exercise-log-header">
                                <span class="exercise-name-log">${exerciseName}</span>
                                <span class="last-session-date">${WorkoutUtils.date.formatKorean(lastSessionRecords[0].date)}</span>
                            </div>
                            <ul class="session-set-list">
                                ${lastSessionRecords.map(set => `
                                    <li class="session-set-item" style="font-weight: ${set.weight === maxWeightInSession ? 'bold' : 'normal'}">
                                        <span>${set.setNumber}세트</span>
                                        <span>${set.weight}kg × ${set.reps}회</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </li>
                    `;
                }).filter(Boolean);

                if (partRecords.length === 0) return '';

                return `
                    <div class="workout-section">
                        <div class="section-title">${part}</div>
                        <ul class="exercise-log-list">
                            ${partRecords.join('')}
                        </ul>
                    </div>
                `;
            }).join('');

            document.getElementById('workout-history').innerHTML = historyHtml;
        }

        function renderProgressTab() {
            const personalRecords = workoutData.getData('personalRecords') || {};
            const exercises = workoutData.getData('exercises') || {};
            const bodyParts = Object.keys(exercises);

            if (Object.keys(personalRecords).length === 0) {
                document.getElementById('progress-content').innerHTML = `
                    <div class="text-center p-8 text-secondary">
                        아직 개인 기록이 없습니다.
                    </div>
                `;
                return;
            }

            const progressHtml = bodyParts.map(part => {
                const partPRs = Object.entries(personalRecords).filter(([name, record]) => 
                    (exercises[part] || []).includes(name)
                );
                
                if (partPRs.length === 0) return '';

                return `
                    <div class="workout-section mb-6">
                        <div class="section-title">${part}</div>
                        ${partPRs.map(([name, record]) => `
                            <div class="card p-4 mb-3">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-bold">${name}</span>
                                    <span class="font-bold">${record.weight}kg × ${record.reps}회</span>
                                </div>
                                <div class="text-sm text-secondary">
                                    추정 1RM: ${record.oneRM}kg | 달성: ${WorkoutUtils.date.formatKorean(record.date)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');

            document.getElementById('progress-content').innerHTML = progressHtml;
        }

        function renderLibraryTab() {
            const exercises = workoutData.getData('exercises') || {};
            const bodyParts = Object.keys(exercises);

            const libraryHtml = `
                <div class="card mb-6">
                    <div class="form-group">
                        <label class="form-label">검색</label>
                        <input type="text" id="library-search" class="form-input" placeholder="운동 이름으로 검색...">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">부위 필터</label>
                            <select id="library-filter" class="form-select">
                                <option value="">전체</option>
                                ${bodyParts.map(part => `<option value="${part}">${part}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group flex items-end">
                            <button id="add-exercise-btn" class="btn btn-primary w-full">새 운동 추가</button>
                        </div>
                    </div>
                </div>

                <div id="add-exercise-form" class="card mb-6 hidden">
                    <div class="card-title">새 운동 추가</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">운동 이름</label>
                            <input type="text" id="new-exercise-name" class="form-input" placeholder="운동 이름을 입력하세요">
                        </div>
                        <div class="form-group">
                            <label class="form-label">부위</label>
                            <select id="new-exercise-bodypart" class="form-select">
                                ${bodyParts.map(part => `<option value="${part}">${part}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button id="save-exercise" class="btn btn-success">추가하기</button>
                        <button id="cancel-exercise" class="btn btn-secondary">취소</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">운동 라이브러리</div>
                    <div id="exercise-library-list">
                        ${renderExerciseList(exercises)}
                    </div>
                </div>
            `;

            document.getElementById('library-content').innerHTML = libraryHtml;

            // 이벤트 리스너 추가
            setupLibraryEventListeners();
        }

        function renderExerciseList(exercises, searchTerm = '', filterBodyPart = '') {
            const allExercises = [];
            Object.entries(exercises).forEach(([bodyPart, exerciseList]) => {
                exerciseList.forEach(name => {
                    if ((!searchTerm || name.toLowerCase().includes(searchTerm.toLowerCase())) &&
                        (!filterBodyPart || bodyPart === filterBodyPart)) {
                        allExercises.push({ name, bodyPart });
                    }
                });
            });

            if (allExercises.length === 0) {
                return '<div class="text-center p-4 text-secondary">운동을 찾을 수 없습니다.</div>';
            }

            return allExercises.map(({ name, bodyPart }) => `
                <div class="exercise-item">
                    <span class="exercise-name">
                        ${name} 
                        <span class="inline-block bg-gray-200 text-gray-600 px-2 py-1 rounded-full text-xs ml-2">${bodyPart}</span>
                    </span>
                    <button class="btn btn-danger btn-sm" onclick="deleteExercise('${bodyPart}', '${name}')">삭제</button>
                </div>
            `).join('');
        }

        function setupLibraryEventListeners() {
            const searchInput = document.getElementById('library-search');
            const filterSelect = document.getElementById('library-filter');
            const addBtn = document.getElementById('add-exercise-btn');
            const addForm = document.getElementById('add-exercise-form');

            searchInput?.addEventListener('input', updateExerciseList);
            filterSelect?.addEventListener('change', updateExerciseList);

            addBtn?.addEventListener('click', () => {
                addForm.classList.remove('hidden');
                addBtn.classList.add('hidden');
            });

            document.getElementById('cancel-exercise')?.addEventListener('click', () => {
                addForm.classList.add('hidden');
                addBtn.classList.remove('hidden');
                clearAddExerciseForm();
            });

            document.getElementById('save-exercise')?.addEventListener('click', handleAddExercise);
        }

        function updateExerciseList() {
            const searchTerm = document.getElementById('library-search').value;
            const filterBodyPart = document.getElementById('library-filter').value;
            const exercises = workoutData.getData('exercises') || {};
            
            document.getElementById('exercise-library-list').innerHTML = 
                renderExerciseList(exercises, searchTerm, filterBodyPart);
        }

        function handleAddExercise() {
            const name = document.getElementById('new-exercise-name').value.trim();
            const bodyPart = document.getElementById('new-exercise-bodypart').value;

            if (!name) {
                alert('운동 이름을 입력하세요.');
                return;
            }

            const success = workoutData.addExercise(bodyPart, name);
            if (success) {
                clearAddExerciseForm();
                document.getElementById('add-exercise-form').classList.add('hidden');
                document.getElementById('add-exercise-btn').classList.remove('hidden');
                updateExerciseList();
                alert(`${name} 운동이 ${bodyPart}에 추가되었습니다.`);
            } else {
                alert('이미 존재하는 운동입니다.');
            }
        }

        function clearAddExerciseForm() {
            document.getElementById('new-exercise-name').value = '';
        }

        window.deleteExercise = function(bodyPart, exerciseName) {
            if (confirm(`'${exerciseName}' 운동을 삭제하시겠습니까?`)) {
                workoutData.removeExercise(bodyPart, exerciseName);
                updateExerciseList();
            }
        };

        // 타이머 관련 함수
        function startTimer() {
            appState.isTimerActive = true;
            appState.timerInterval = setInterval(() => {
                appState.timerTime++;
                updateTimerDisplay();
            }, 1000);
            
            document.getElementById('timer-start').classList.add('hidden');
            document.getElementById('timer-stop').classList.remove('hidden');
        }

        function stopTimer() {
            appState.isTimerActive = false;
            if (appState.timerInterval) {
                clearInterval(appState.timerInterval);
                appState.timerInterval = null;
            }
            
            document.getElementById('timer-start').classList.remove('hidden');
            document.getElementById('timer-stop').classList.add('hidden');
        }

        function resetTimer() {
            stopTimer();
            appState.timerTime = 0;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            document.getElementById('timer-display').textContent = WorkoutUtils.timer.formatTime(appState.timerTime);
        }

        function copyTodaysWorkout() {
            const now = new Date();
            const startOfToday = WorkoutUtils.date.getStartOfDay(now);
            const workoutHistory = workoutData.getData('workoutHistory') || [];
            
            const todaysWorkouts = workoutHistory
                .filter(w => new Date(w.date) >= startOfToday)
                .reverse();
            
            if (todaysWorkouts.length === 0) {
                alert('오늘 기록된 운동이 없습니다.');
                return;
            }

            const groupedByExercise = todaysWorkouts.reduce((acc, workout) => {
                if (!acc[workout.name]) acc[workout.name] = [];
                acc[workout.name].push(workout);
                return acc;
            }, {});

            let clipboardText = `[${WorkoutUtils.date.formatKorean(now)} 운동 기록]\n\n`;
            
            for (const exerciseName in groupedByExercise) {
                clipboardText += `🔥 ${exerciseName}\n`;
                const sets = groupedByExercise[exerciseName];
                const mainNote = sets.find(s => s.notes)?.notes || '';
                
                sets.sort((a, b) => a.setNumber - b.setNumber).forEach(set => {
                    clipboardText += `  - ${set.setNumber}세트: ${set.weight}kg x ${set.reps}회\n`;
                });
                
                if (mainNote) clipboardText += `  📝 메모: ${mainNote}\n`;
                clipboardText += '\n';
            }

            navigator.clipboard.writeText(clipboardText.trim()).then(() => {
                alert('오늘의 운동 기록이 클립보드에 복사되었습니다!');
            }).catch(() => {
                // 폴백: 텍스트 영역 사용
                const textarea = document.createElement('textarea');
                textarea.value = clipboardText.trim();
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    alert('오늘의 운동 기록이 클립보드에 복사되었습니다!');
                } catch (err) {
                    alert('복사에 실패했습니다.');
                }
                document.body.removeChild(textarea);
            });
        }

        function restoreState() {
            // 저장된 사용자 설정 복원
            const lastBodyPart = workoutData.getUserPreference('lastSelectedBodyPart');
            if (lastBodyPart) {
                appState.selectedBodyPart = lastBodyPart;
            }
        }

        function render() {
            renderTabContent(appState.activeTab);
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            
            // 데이터 변경 감지
            workoutData.onDataChange((event) => {
                console.log('Data changed:', event.detail);
                // 필요시 UI 업데이트
                if (appState.activeTab === 'workout') {
                    renderWorkoutHistory();
                }
            });
        });
        
        // 운동 기록 저장 시 클라우드 동기화
        async function saveWorkoutRecord() {
            const records = getWorkoutRecords();
            
            if (records.length === 0) {
                alert('저장할 운동 기록이 없습니다.');
                return;
            }
            
            try {
                // 클라우드 + 로컬 저장
                const result = await workoutData.addWorkoutRecord(records);
                
                if (result.success) {
                    alert(`${result.recordsAdded}개의 운동 기록이 저장되었습니다.`);
                    clearWorkoutForm();
                    renderWorkoutHistory();
                    renderProgressTab();
                } else {
                    alert('운동 기록 저장에 실패했습니다.');
                }
            } catch (error) {
                console.error('운동 기록 저장 중 오류:', error);
                alert('운동 기록 저장 중 오류가 발생했습니다.');
            }
        }
        
        // 운동 기록 데이터 수집
        function getWorkoutRecords() {
            const records = [];
            const exerciseName = appState.selectedExercise;
            
            if (!exerciseName) return records;
            
            appState.sets.forEach((set, index) => {
                if (set.weight && set.reps && set.weight > 0 && set.reps > 0) {
                    records.push({
                        id: `${Date.now()}_${index}`,
                        name: exerciseName,
                        weight: parseFloat(set.weight),
                        reps: parseInt(set.reps),
                        date: new Date().toISOString().split('T')[0],
                        notes: appState.notes || '',
                        setNumber: index + 1,
                        bodyPart: appState.selectedBodyPart
                    });
                }
            });
            
            return records;
        }
        
        // 운동 기록 폼 초기화
        function clearWorkoutForm() {
            appState.sets = Array.from({ length: 5 }, () => ({ weight: '', reps: '' }));
            appState.notes = '';
            renderExerciseForm();
        }
    </script>
</body>
</html>